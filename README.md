# ByteCTF2024-Final-C2

ByteCTF2024 大师赛“蓝军-隐秘的通道”解决方案，获得冠军。实现基于飞书、微信、钉钉和 Github 的跨平台、多通道的简单 C2 通讯框架，适用于通信受限场景。

## 项目目标

* 基于企业级通信平台（飞书、企业微信、钉钉、GitHub）实现命令与控制（C2）通信
* 支持命令执行、文件传输、socks5 隧道等核心功能
* 兼容 Windows/Linux/macOS 多平台
* 支持高速文件传输与持久 session 管理

## 依赖组件

* [gost](https://github.com/go-gost/gost)：用于提供 socks5 服务。
* [File-Tunnel](https://github.com/fiddyschmitt/File-Tunnel)：用于将 TCP 流封装为文件进行传输，以规避网络检测。

## 系统架构

系统分为三层：

1. 通信层：处理机器人 API 通信、Token 管理、群聊管理等
2. 命令处理层：包含命令解析、路由、执行、结果封装等功能
3. 文件操作层：处理目录管理、文件读写、上传下载等任务

## 通信通道设计

| 平台         | 通道机制              | 实现特点                                   |
| ---------- | ----------------- | -------------------------------------- |
| **飞书**     | 富文本推拉接口           | 支持交互式 shell、高速文件同步（>100MB/s）、文件通道转 TCP |
| **GitHub** | 仓库中文件读写           | 可同时管理多个受控端，支持 Session 管理与交互式命令执行       |
| **钉钉**     | wss 双向流式通信        | 实现基础 C2 功能                             |
| **企业微信**   | webhook + 公众号文章接口 | webhook 可用于下发指令，使用公众号文章接口绕过接收限制        |

## 核心功能模块

- [x] 命令执行
- [x] 文件操作
- [x] socks5 代理
- [x] 多客户端管理

## 改进方向

* 代码只用于验证 C2 通讯思路，无法直接用于真实场景
* 当前 file-tunnel 的 TCP 转发机制存在 0.5\~1s 的延迟，socks5 握手多次导致整体吞吐下降
* 基于开放 API 的通信方式容易受平台 QPS 限制

